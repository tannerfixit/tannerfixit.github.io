<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    </head>
    <body onload="loadTasks()">
        <div class="header">
            <h1>My iFixit Devices</h1>
            
            <input method = "get" type="text" class="searchbar" action="javascript" placeholder="Enter a device">
            <div>
                <h3>Device Explorer</h3>
                <h3>My Devices</h3>
            </div>
        </div>
        <div class="main">
            <div class="results">
                <h3>Search for devices you own</h3>
<!--
                <div class='result'>
                    <img class='result_image'>
                    <div>
                        <h1 class='result_title'>iPhone</h1>
                        <h3 class='result_url'>URL</h3>
                    </div>
                </div>
-->
            </div>
        </div>
        <div class="bag">
            <h3>My Items</h3>
        </div>
        <script>
            
            $(".searchbar").change(function(){
                var ifixitAPI = "https://www.ifixit.com/api/2.0/suggest/"+$(".searchbar").val()+"?doctypes=device";
                var request = $.ajax({
                    url: ifixitAPI
                });
                
                //Successful response from server
                request.done(function(response) {
                    var length = response.results.length;
                    console.log(response.results[0]);
                    $(".results .result").remove();
                    //Parse the results from the server into useable objects
                    for (i=0; i<length; i++){
                        var image = response.results[i].image.thumbnail;
                        var device = response.results[i].title;
//                        var deviceID = device.replace(/ /g,"_");
                        var url = response.results[i].url;
                        var id= response.results[i].wikiid;
                        populateResults(".results",image, device, id, response);
                    }
                    //Show the results that were just parsed on screen
                    $(".result").fadeIn("fast");
                    
                    //LocalStorage setup if no array is found
                    if (!localStorage.items)
                        localStorage.items = JSON.stringify([]);
                    
                    //Parse the string of data with JSON
                    var items = JSON.parse(localStorage["items"]);
                    
                    //Add or remove an item from the array if a result is clicked
                    $(".result").click(function(){
                        var id=$(this).attr("id");
                        $("#"+id+" .add").toggleClass("rotate");
                        //Add to the array
                        if ($("#"+id+" .add").hasClass("rotate")){
//                            var image = $(this+" .result_image").attr('src');
//                            alert(image);
//                            $(".main").append($("#"+id+" img").html());
                            var image = $(this).find("img").attr("src");;
                            var device = $("#"+id+" h2").html();
                            $(".bagResult").remove();
                            items.push([image,device,id]);
                        }
                        //Remove ID from array
                        else{
                            items = jQuery.grep(items, function(value){
                                return value[2] != id;
                            })
                        }
                        $(".bagResult").remove();
                        addToBag(items);
                        //Package up the array back into a string for localStorage
                        localStorage["items"] = JSON.stringify(items);
                    });
                });
                
                // If no internet connection, jump to here
                request.fail(function(msg){
                    $(".result").remove();
                    $(".results").append("<div class='result'><p>Something went wrong...</p></div>");
                    $(".result").hide();
                    $(".result").fadeIn("fast");
                });
            });
            
            $(".header h1").click(function(){
                localStorage.count = 0;
            })
            $(".header div h3:nth-child(2)").click(function(){
                $(".main").hide();
                $(".bag").fadeIn("fast");
                $(this).addClass("selected");
                $(".header div h3:nth-child(1)").removeClass("selected");
            })
            $(".header div h3:nth-child(1), .searchbar").click(function(){
                $(".main").fadeIn("fast");
                $(".bag").hide();
                if (!$(this).hasClass("searchbar")){
                    $(this).addClass("selected");
                }
                $(".header div h3:nth-child(2)").removeClass("selected");
            });
            
            function populateResults(location, image, device, id, response){
                $(location).append("<div class='result' id="+id+"></div>");
                $("#"+id).append("<img class='result_image' src="+image+">");
                $("#"+id).css("animation-delay",".0"+i+"s");
                $("#"+id).append("<div></div>");
                $("#"+id+" div").append("<h2 class='result_title'>"+device+"</h2>");
                $("#"+id).append("<div class='add'><div></div><div></div></div>");
            }
            
            function addToBag(items){
                for (i=0; i<items.length; i++){
                    var image = items[i][0];
                    var device = items[i][1];
                    var id = items[i][2];
                    $(".bag").append("<div class='bagResult' id="+id+1+"></div>");
                    $(".bag #"+id+1).append("<img class='result_image' src="+image+">");
                    $(".bag #"+id+1).append("<div></div>");
                    $(".bag #"+id+1).css("animation-delay",".0"+i+"s");
                    $(".bag #"+id+1+" div").append("<h2 class='result_title'>"+device+"</h2>");
                    $(".bag #"+id+1).append("<div class='add'><div></div><div></div></div>");
                    $(".bag #"+id+1+" .add").addClass("rotate");
                }
                
                $(".bagResult").fadeIn("fast");
                $(".bagResult").click(function(){
                    var id=$(this).attr("id");
                    //Add to the array
                    if ($("#"+id+" .add").hasClass("rotate")){
                        var image = $(this).find("img").attr("src");;
                        var device = $("#"+id+" h2").html();
                        $(this).remove();
                        var oldID = id.slice(0,-1);
                        $(".results #"+oldID).removeClass("rotate");
                    }
                    //Find item to remove from array
                    items = jQuery.grep(items, function(value){
                        return value[2]+1 != id;
                    })
                    //Save new array in localStorage
                    localStorage["items"] = JSON.stringify(items);
                });

            }
            
            function loadTasks(){
                if (localStorage.items)
                    var items = JSON.parse(localStorage.getItem("items"));
                addToBag(items);
            }
            
            $(".header h1").click(function(){
                localStorage.removeItem("items");
                $(".result div").removeClass("rotate");
            });

        </script>
    </body>
</html>